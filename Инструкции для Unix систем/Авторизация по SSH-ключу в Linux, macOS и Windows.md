# Авторизация по SSH-ключу в Linux, macOS и Windows

Использование SSH-ключей для подключения к серверу обеспечивает более высокий уровень безопасности и удобства по сравнению с традиционной авторизацией по паролю. Это снижает вероятность взлома учетной записи и избавляет от необходимости вводить пароль при каждом соединении.

В этой статье мы рассмотрим процесс настройки SSH-авторизации с помощью ключей для Linux, macOS и Windows.

## Зачем использовать SSH-ключи?

При авторизации с использованием SSH-ключа клиент отправляет серверу уникальный публичный ключ, а сервер проверяет его соответствие заранее сохраненному ключу. Если ключи совпадают, подключение устанавливается без необходимости ввода пароля.

### Преимущества использования SSH-ключей:

- **Усиленная безопасность** – отсутствие пароля в системе снижает риск брутфорс-атак.
- **Удобство** – можно входить на сервер без ввода пароля.
- **Гибкость** – ключи можно легко распространять между разными машинами или серверами.

---

## 1. Создание SSH-ключей

SSH-ключи состоят из пары файлов:

- **Приватный ключ** (`id_rsa`) – хранится на вашем компьютере и должен оставаться в секрете.
- **Публичный ключ** (`id_rsa.pub`) – загружается на сервер.

Для Linux, macOS и Windows 10 (начиная с версии 1809) используется встроенный SSH-клиент. Чтобы создать ключи, выполните команду:

```bash
ssh-keygen -t rsa -b 4096
```

После запуска появится приглашение:

```bash
Generating public/private rsa key pair.
Enter file in which to save the key (/home/user/.ssh/id_rsa):
```

Нажмите **Enter**, чтобы использовать путь по умолчанию. Затем вам предложат задать парольную фразу (можно оставить пустой, просто нажав **Enter**).

Далее вам будет предложено задать пароль (кодовую фразу) для ключа. Вы можете задать ее или оставить пустой, просто нажав **Enter**. Обратите внимание, что если вы зададите кодовую фразу, ее потребуется вводить при каждой авторизации по ключу.

После этого SSH-ключи будут созданы в директории `~/.ssh/`:

- `id_rsa` – приватный ключ.
- `id_rsa.pub` – публичный ключ.

Чтобы вывести публичный ключ в терминал, используйте команду:

```bash
cat ~/.ssh/id_rsa.pub
```

В Windows используйте команду:

```powershell
Get-Content $env:USERPROFILE\.ssh\id_rsa.pub
```

или

```powershell
type $env:USERPROFILE\.ssh\id_rsa.pub
```

---

## 2. Копирование ключа на сервер

Теперь необходимо добавить публичный ключ в файл `~/.ssh/authorized_keys` на сервере.

### Для Linux и macOS:

```bash
ssh-copy-id user@server
```

Пример:

```bash
ssh-copy-id root@192.168.1.100
```

### Для Windows (PowerShell):

```powershell
type $env:USERPROFILE\.ssh\id_rsa.pub | ssh user@server "cat >> .ssh/authorized_keys"
```

Пример:

```powershell
type $env:USERPROFILE\.ssh\id_rsa.pub | ssh root@192.168.1.100 "cat >> .ssh/authorized_keys"
```

Теперь можно подключаться без ввода пароля:

```bash
ssh user@server
```

---

## 3. Решение возможных проблем

### 3.1. Ошибка `key type ssh-rsa not in PubkeyAcceptedAlgorithms`

Если в логах SSH на сервере (`sudo journalctl -u ssh`) вы видите ошибку:

```bash
userauth_pubkey: key type ssh-rsa not in PubkeyAcceptedAlgorithms [preauth]
```

Это значит, что сервер не принимает ключи типа `ssh-rsa`. Можно разрешить их, добавив в файл `/etc/ssh/sshd_config.d/enable_rsa_keys.conf`:

```ini
HostKeyAlgorithms +ssh-rsa
PubkeyAcceptedKeyTypes +ssh-rsa
```

После чего перезапустить SSH:

```bash
sudo systemctl restart sshd
```

Альтернативное решение – создать ключ с более надежным шифрованием:

```bash
ssh-keygen -t ed25519
```

Затем снова загрузить новый ключ на сервер.

---

## 4. Использование SSH-ключей в старых версиях Windows (без OpenSSH)

Для старых версий Windows потребуется программа **PuTTYgen**. Скачайте `puttygen.exe` с [официального сайта PuTTY](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html).

### 4.1. Генерация ключей через PuTTYgen

1. Запустите `PuTTYgen`.
2. Выберите **RSA** и нажмите **Generate**.
3. В хаотичном порядке двигайте мышью для генерации случайных значений.
4. После создания ключа сохраните его, нажав **Save public key** и **Save private key**.
5. Скопируйте текст из окна **Public key for pasting…** – он потребуется для загрузки ключа на сервер.

### 4.2. Добавление ключа на сервер вручную

Войдите на сервер через SSH и выполните:

```bash
mkdir -p ~/.ssh
chmod 0700 ~/.ssh
nano ~/.ssh/authorized_keys
```

Вставьте скопированный ключ в файл и сохраните.

Теперь при подключении через PuTTY выберите свой приватный ключ (`.ppk`).

---

## 5. Отключение доступа по паролю

После успешной настройки SSH-ключей можно запретить вход по паролю для повышения безопасности.

Откройте конфигурационный файл SSH:

```bash
sudo nano /etc/ssh/sshd_config
```

Найдите строку:

```ini
PasswordAuthentication yes
```

Замените ее на:

```ini
PasswordAuthentication no
```

Сохраните изменения и перезапустите SSH:

```bash
sudo systemctl restart sshd
```

Чтобы проверить, что сервер не принимает пароли, попробуйте войти с другого устройства.

---

## Заключение

Теперь ваш сервер защищен от брутфорс-атак, а вход по SSH стал быстрее и удобнее. Использование SSH-ключей – это лучший способ защитить учетную запись сервера и обеспечить надежную авторизацию.

Если у вас возникли вопросы, проверьте настройки файлов `~/.ssh/authorized_keys` и `sshd_config`.\
Для дополнительной безопасности используйте ключи `ed25519` вместо устаревших `rsa`.\
Настроить SSH-ключи можно не только для входа в сервер, но и для подключения к другим сервисам (например, GitHub).

Следуя этим шагам, вы обеспечите себе надежную и удобную авторизацию по SSH!

